name: Document
on:
  workflow_dispatch:
    inputs:
      board:
        description: Keyboard to create docs for
        required: true
        type: choice
        options:
        - amoeba
        - amoeba

jobs:
  export:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./kicad/${{ inputs.board }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create doc_out folder with write access
        run: |
          mkdir doc_out
          ls -la 

      - name: KiBot
        uses: INTI-CMNB/KiBot@v2_dk6
        with:
          config: ./kicad/bin/doc.kibot.yaml
          schema: ./kicad/${{ inputs.board }}/${{ inputs.board }}.kicad_sch
          board: ./kicad/${{ inputs.board }}/${{ inputs.board }}.kicad_pcb
          dir: ./kicad/${{ inputs.board }}
          verbose: 1

      - name: Resize render, zip
        run: |
          convert doc_out/${{ inputs.board }}-3D_top.png -resize 1200 doc_out/${{ inputs.board }}-3D_1200.png
          ls -la . doc_out
          cd doc_out
          zip ../${{ inputs.board }}-Doc.zip *.html *.png *.svg
          
      - name: Upload Docs Zip
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.board }}-docs
          path: ./kicad/${{ inputs.board }}/${{ inputs.board }}-Doc.zip

      ####
      # Logs
      - name: Debug list directory
        if: ${{ always() }}
        run: |
          pwd
          ls -la . doc_out

      - name: Upload Logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.board }}-docs_debug_logs
          path: |
            ./kicad/${{ inputs.board }}/*.log
            ./kicad/${{ inputs.board }}/*.txt
            ./kicad/${{ inputs.board }}/doc_out/*.log
            ./kicad/${{ inputs.board }}/doc_out/*.txt
